<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="dang">

	<!-- 댕모임 번호 반환 -->
	<select id = "dangNo" resultType = "int">
		select dang_seq.nextval from dual
	</select>

	<!-- 댕모임 개설 (공개) -->
	<insert id = "createPublic" parameterType = "DangDto">
		insert into dang(dang_no, dang_area, user_no, dang_name, dang_info, dang_headmax) values(#{dangNo}, #{dangArea}, #{userNo}, #{dangName}, #{dangInfo}, #{dangHeadmax})
	</insert>
  
  	<!-- 댕모임 개설 (비공개) -->
  	<insert id = "createPrivate" parameterType = "DangDto">
  		insert into dang(dang_no, dang_area, user_no, dang_name, dang_info, dang_headmax, dang_private, dang_pw) values(#{dangNo}, #{dangArea}, #{userNo}, #{dangName}, #{dangInfo}, #{dangHeadmax}, 'Y', #{dangPw})
  	</insert>
  	
  	<!-- 댕모임 프로필 첨부파일 정보 등록 -->
  	<insert id = "insertDangImg" parameterType = "map">
  	  	insert into dang_img(dang_no, attachment_no) values(#{dangNo}, #{attachmentNo})
  	</insert>
  	
  	<!-- 댕모임 정보 조회 -->
  	<select id = "selectDangEditInfo" parameterType = "int" resultType = "DangEditInfoVO">
  		select d.dang_no, d.dang_name, d.dang_info, d.dang_headmax, d.dang_head, d.dang_private, d.dang_pw, d.dang_area, di.attachment_no
  			from dang d left outer join dang_img di on d.dang_no = di.dang_no where d.dang_no = #{dangNo}
  	</select>
  	
  	<!-- 댕모임 단일조회(첨부파일 + 댕모임) -->
	<select id="selectOneDangInfo" parameterType = "int" resultType = "DangOneInfoVO">
		select d.*, img.attachment_no from dang d 
		left outer join dang_img img on d.dang_no=img.dang_no
		where d.dang_no=#{dangNo}
	</select>
	
  	<!-- 댕모임 정보 수정(공개 전환) -->
  	<update id = "editDangInfoPublic" parameterType = "DangEditInfoVO">
  		update dang set dang_name = #{dangName}, dang_info = #{dangInfo}, dang_headmax = #{dangHeadmax}, dang_private = #{dangPrivate}, dang_pw = null, dang_area = #{dangArea} where dang_no = #{dangNo}
  	</update>
  	
  	<!-- 댕모임 정보 수정(비공개 전환) -->
  	<update id = "editDangInfoPrivate" parameterType = "DangInfoVO">
  		update dang set dang_name = #{dangName}, dang_info = #{dangInfo}, dang_headmax = #{dangHeadmax}, dang_private = #{dangPrivate}, dang_pw = #{dangPw}, dang_area = #{dangArea} where dang_no = #{dangNo}
  	</update>
  	
  	<!-- 댕모임 프로필 첨부파일 번호 조회 -->
  	<select id = "selectDangImg" parameterType = "int" resultType = "int">
  		select attachment_no from dang_img where dang_no = #{dangNo}
  	</select>
  	
  	<!-- 지역구별 댕모임 5개 조회(좋아요 순/회원수 순) -->
  	<select id = "searchDangTop" parameterType = "String" resultType = "DangTopVO">
  		select * from (select tmp.*, rownum rn from(select dang_no, dang_name, dang_area from dang where dang_area = #{dangArea} order by dang_like, dang_head)tmp) where rn between 1 and 5
  	</select>
  	
  	<!-- 댕모임 번호로 등록된 해시태그 전체 조회 -->
 	<select id = "selectHashtagList" parameterType = "int" resultType = "DangHashtagVO">
 		select hashtag_no, hashtag_content from dang_hashtag where dang_no = #{dangNo}
 	</select>
 	
 	<!-- 댕모임 번호로 첨부파일 조회 -->
  		
  	<!-- 댕모임 상세 정보 -->
 	<select id = "selectDangDetail" parameterType = "int" resultMap = "dangDetailDto">
 		select * from dang d left outer join dang_img di on d.dang_no = di.dang_no where d.dang_no = #{dangNo}
 	</select>
 	<resultMap id = "dangDetailDto" type = "DangDetailDto">
 		<association property = "dangInfo">
 			<result column = "dang_no" property = "dangNo"/>
 			<result column = "dang_name" property = "dangName"/>
 			<result column = "dang_info" property = "dangInfo"/>
 			<result column = "dang_headmax" property = "dangHeadmax"/>
 			<result column = "dang_head" property = "dangHead"/>
 			<result column = "dang_area" property = "dangArea"/>
 			<result column = "dang_createtime" property = "dangCreatetime" javaType="java.sql.Date"/>
 			<result column = "dang_like" property = "dangLike"/>
 			<result column = "dang_private" property = "dangPrivate"/>
 			<result column = "dang_pw" property = "dangPw"/>
 			<result column = "attachment_no" property = "attachmentNo"/>
 		</association>
 		<collection column = "dang_no" property = "dangHashtag" javaType = "java.util.List" ofType = "DangHashtagVO" select = "selectHashtagList">
 			<result column = "hashtag_no" property = "hashtagNo"></result>
 			<result column = "hashtag_content" property = "hashtagContent"></result>
 		</collection>
 	</resultMap>
 	
 	<!-- 댕모임 조회 -->
 	<select id = "selectDangList" parameterType = "DangListRequestDto" resultMap = "dangListDto">
 		select * from (
			select tmp.*, rownum rn from (
	 		<choose>
 			<when test = "userNo != null">
 				select
				dudldid.attachment_no, dudldid.dang_no, dudldid.dang_name, dudldid.dang_info, dudldid.dang_headmax, dudldid.dang_head, dudldid.dang_createtime, dudldid.dang_like, dudldid.dang_private, dudldid.dang_pw, dudldid.dang_area, count(case when dudldid.user_no = #{userNo} then 1 end) as is_like 
				from
				(select did.*, dudl.user_no from 
				    (select dl.dang_no, dl.user_no from dang_like dl inner join dang_user du on dl.user_no = du.user_no) dudl
				        right outer join 
				    (select di.attachment_no, d.dang_no, d.dang_name, d.dang_info, d.dang_headmax, d.dang_head, d.dang_createtime, d.dang_like, d.dang_private, d.dang_pw, d.dang_area from dang_img di right outer join dang d on di.dang_no = d.dang_no) did
				on dudl.dang_no = did.dang_no)
				dudldid 
				<where>
		 			<if test = "searchName != null">
		 				and instr(dudldid.dang_name, #{searchName}) > 0
		 			</if>
		 			<if test = "searchName != null and searchArea != null">
			 			and (
			 		</if>		 		
			 		<if test = "searchArea != null">
		 				<foreach collection = "searchArea" item = "searchArea" separator = "or"> 				
			 				instr(dudldid.dang_area, #{searchArea}) > 0
		 				</foreach>
		 			</if>
		 			<if test = "searchName != null and searchArea != null">
			 			)
			 		</if>
		 		</where>
				group by dudldid.attachment_no, dudldid.dang_no, dudldid.dang_name, dudldid.dang_info, dudldid.dang_headmax, dudldid.dang_head, dudldid.dang_createtime, dudldid.dang_like, dudldid.dang_private, dudldid.dang_pw, dudldid.dang_area
 			</when>
 			<otherwise>
 				select
				dudldid.attachment_no, dudldid.dang_no, dudldid.dang_name, dudldid.dang_info, dudldid.dang_headmax, dudldid.dang_head, dudldid.dang_createtime, dudldid.dang_like, dudldid.dang_private, dudldid.dang_pw, dudldid.dang_area, 0 as is_like 
				from
				(select did.*, dudl.user_no from 
				    (select dl.dang_no, dl.user_no from dang_like dl inner join dang_user du on dl.user_no = du.user_no) dudl
				        right outer join 
				    (select di.attachment_no, d.dang_no, d.dang_name, d.dang_info, d.dang_headmax, d.dang_head, d.dang_createtime, d.dang_like, d.dang_private, d.dang_pw, d.dang_area from dang_img di right outer join dang d on di.dang_no = d.dang_no) did
				on dudl.dang_no = did.dang_no)
				dudldid 
				<where>
		 			<if test = "searchName != null">
		 				and instr(dudldid.dang_name, #{searchName}) > 0
		 			</if>
		 			<if test = "searchArea != null">
			 			and (
			 		</if>
			 		<if test = "searchArea != null">
		 				<foreach collection = "searchArea" item = "searchArea" separator = "or"> 				
			 				instr(dudldid.dang_area, #{searchArea}) > 0
		 				</foreach>
		 			</if>
		 			<if test = "searchName != null and searchArea != null">
			 			)
			 		</if>
		 		</where>
				group by dudldid.attachment_no, dudldid.dang_no, dudldid.dang_name, dudldid.dang_info, dudldid.dang_headmax, dudldid.dang_head, dudldid.dang_createtime, dudldid.dang_like, dudldid.dang_private, dudldid.dang_pw, dudldid.dang_area
 			</otherwise>
	 		</choose>
 		<if test = "sort != null">
 			order by ${sort}
 		</if>
 		)tmp
		) where rn between #{rownumStart} and #{rownumEnd}
 	</select>
 	<resultMap id = "dangListDto" type = "DangListResponseDto">
 		<association property = "dangInfo">
 			<result column = "attachment_no" property = "attachmentNo"/>
 			<result column = "dang_no" property = "dangNo"/>
 			<result column = "dang_name" property = "dangName"/>
 			<result column = "dang_info" property = "dangInfo"/>
 			<result column = "dang_headmax" property = "dangHeadmax"/>
 			<result column = "dang_head" property = "dangHead"/>
 			<result column = "dang_area" property = "dangArea"/>
 			<result column = "dang_createtime" property = "dangCreatetime" javaType="java.sql.Date"/>
 			<result column = "dang_like" property = "dangLike"/>
 			<result column = "dang_private" property = "dangPrivate"/>
 			<result column = "dang_pw" property = "dangPw"/>
 			<result column = "is_like" property = "isLike"/>
 		</association>
 		<collection column = "dang_no" property = "dangHashtag" javaType = "java.util.List" ofType = "DangHashtagVO" select = "selectHashtagList">
 			<result column = "hashtag_no" property = "hashtagNo"></result>
 			<result column = "hashtag_content" property = "hashtagContent"></result>
 		</collection>
 	</resultMap>
 
 	<!-- 댕모임 목록 갯수 -->
 	<select id = "countDangTotal" parameterType = "DangListRequestDto" resultType = "int">
 		select count(*) from dang
 		<where>
 			<if test = "searchName != null">
 				and instr(dang_name, #{searchName}) > 0
 			</if>
 			<if test = "searchArea != null">
	 			and (
	 		</if>
	 		<if test = "searchArea != null">
 				<foreach collection = "searchArea" item = "searchArea" separator = "or"> 				
	 				instr(dang_area, #{searchArea}) > 0
 				</foreach>
 			</if>
 			<if test = "searchArea != null">
	 			)
	 		</if>
 		</where>
 	</select>
 	
 	<!-- 댕모임 회원수 갱신 -->
 	<update id = "updateDangHead" parameterType = "map">
 		update dang set dang_head = #{dangHead} where dang_no = #{dangNo}
 	</update>
 	
 	<!-- 댕모임 회원수 갱신 -->
 	<update id = "minusDangHead" parameterType = "int">
 		update dang set dang_head = dang_head-1 where dang_no = #{dangNo}
 	</update>
 	
	<!-- 댕모임 좋아요 갯수 갱신 -->
	<update id = "updateDangLike" parameterType = "map">
		update dang set dang_like = #{dangLike} where dang_no = #{dangNo}
	</update>
	
	<!-- 마이페이지 내가 가입한 댕모임 -->
	<select id = "selectMydang" parameterType = "int" resultType = "DangUserJoinVO">
		select ddi.*, dm.member_joindate from dang_member dm 
		inner join 
		(select d.dang_no, d.dang_name, d.dang_info, d.dang_area, d.dang_private, di.attachment_no from dang d left outer join dang_img di on d.dang_no = di.dang_no) ddi 
		on dm.dang_no = ddi.dang_no
		where dm.user_no = #{userNo}
	</select>
  	
</mapper>